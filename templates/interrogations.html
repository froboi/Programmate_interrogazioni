{% extends "base.html" %}

{% block title %}Interrogazioni Salvate{% endblock %}

{% block content %}
<div class="container">
    <h1>üìã Interrogazioni Salvate</h1>
    
    <!-- Filtri -->
    <div class="filters-section">
        <h3>üîç Filtri</h3>
        <div class="filter-row">
            <div class="form-group">
                <label for="filterMateria">Materia:</label>
                <input type="text" id="filterMateria" placeholder="Es: Matematica">
            </div>
            <div class="form-group">
                <label for="filterStudent">ID Studente:</label>
                <input type="number" id="filterStudent" placeholder="ID studente">
            </div>
            <div class="form-group">
                <label for="filterLimit">Limite risultati:</label>
                <input type="number" id="filterLimit" placeholder="Es: 50">
            </div>
            <button onclick="loadInterrogations()" class="btn btn-primary">Filtra</button>
            <button onclick="clearFilters()" class="btn btn-secondary">Reset</button>
            <button onclick="exportToPDF()" class="btn btn-success" style="margin-left: 10px;">
                üìÑ Esporta PDF
            </button>
        </div>
    </div>

    <!-- Statistiche -->
    <div id="stats" class="stats-section" style="display: none;">
        <h3>üìä Statistiche</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Totale Interrogazioni</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="materiaCount">0</div>
                <div class="stat-label">Materie</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="studentCount">0</div>
                <div class="stat-label">Studenti Coinvolti</div>
            </div>
        </div>
    </div>

    <!-- Tabella Interrogazioni -->
    <div id="interrogationsTable" class="table-section">
        <h3>üìñ Elenco Interrogazioni</h3>
        <div id="loadingMessage" class="message info">
            <p>Caricamento interrogazioni...</p>
        </div>
        <div id="errorMessage" class="message error" style="display: none;"></div>
        <div id="tableContainer" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Materia</th>
                        <th>Studente</th>
                        <th>Numero Registro</th>
                        <th>Lezione N¬∞</th>
                        <th>Data Lezione</th>
                        <th>Ordine</th>
                        <th>Data Creazione</th>
                    </tr>
                </thead>
                <tbody id="interrogationsBody">
                    <!-- Dati caricati dinamicamente -->
                </tbody>
            </table>
        </div>
        <div id="emptyMessage" class="message warning" style="display: none;">
            <p>Nessuna interrogazione trovata nel database.</p>
        </div>
    </div>

    <!-- Dettagli Interrogazione -->
    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeDetails()">&times;</span>
            <h2>Dettagli Interrogazione</h2>
            <div id="detailsContent"></div>
        </div>
    </div>
</div>

<style>
.filters-section {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.filter-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.form-group {
    flex: 1;
    min-width: 150px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.stats-section {
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.table-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.data-table th {
    background: #667eea;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: bold;
}

.data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
}

.data-table tbody tr:hover {
    background: #f9f9f9;
    cursor: pointer;
}

.message {
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
}

.message.info {
    background: #e3f2fd;
    color: #1976d2;
}

.message.error {
    background: #ffebee;
    color: #c62828;
}

.message.warning {
    background: #fff3e0;
    color: #e65100;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #757575;
    color: white;
}

.btn-secondary:hover {
    background: #616161;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}
</style>

<script>
// Carica le interrogazioni all'avvio
document.addEventListener('DOMContentLoaded', () => {
    loadInterrogations();
});

// Funzione per caricare le interrogazioni
async function loadInterrogations() {
    const loadingMsg = document.getElementById('loadingMessage');
    const errorMsg = document.getElementById('errorMessage');
    const tableContainer = document.getElementById('tableContainer');
    const emptyMsg = document.getElementById('emptyMessage');
    const statsSection = document.getElementById('stats');
    
    // Reset visualizzazione
    loadingMsg.style.display = 'block';
    errorMsg.style.display = 'none';
    tableContainer.style.display = 'none';
    emptyMsg.style.display = 'none';
    statsSection.style.display = 'none';
    
    // Costruisci URL con parametri
    const params = new URLSearchParams();
    const materia = document.getElementById('filterMateria').value;
    const studentId = document.getElementById('filterStudent').value;
    const limit = document.getElementById('filterLimit').value;
    
    if (materia) params.append('materia', materia);
    if (studentId) params.append('student_id', studentId);
    if (limit) params.append('limit', limit);
    
    try {
        const response = await fetch(`/api/interrogations?${params.toString()}`);
        const data = await response.json();
        
        loadingMsg.style.display = 'none';
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        if (data.count === 0) {
            emptyMsg.style.display = 'block';
            return;
        }
        
        // Mostra statistiche
        displayStats(data.interrogations);
        statsSection.style.display = 'block';
        
        // Mostra tabella
        displayTable(data.interrogations);
        tableContainer.style.display = 'block';
        
    } catch (error) {
        loadingMsg.style.display = 'none';
        errorMsg.textContent = `Errore: ${error.message}`;
        errorMsg.style.display = 'block';
    }
}

// Visualizza statistiche
function displayStats(interrogations) {
    const materieSet = new Set(interrogations.map(i => i.materia));
    const studentiSet = new Set(interrogations.map(i => i.student_id));
    
    document.getElementById('totalCount').textContent = interrogations.length;
    document.getElementById('materiaCount').textContent = materieSet.size;
    document.getElementById('studentCount').textContent = studentiSet.size;
}

// Visualizza tabella
function displayTable(interrogations) {
    const tbody = document.getElementById('interrogationsBody');
    tbody.innerHTML = '';
    
    interrogations.forEach(interr => {
        const row = tbody.insertRow();
        row.onclick = () => showDetails(interr.id);
        
        row.insertCell(0).textContent = interr.id;
        row.insertCell(1).textContent = interr.materia;
        row.insertCell(2).textContent = interr.student ? 
            `${interr.student.nome} ${interr.student.cognome}` : 'N/A';
        row.insertCell(3).textContent = interr.student ? 
            interr.student.registro_num : 'N/A';
        row.insertCell(4).textContent = interr.lezione_num;
        row.insertCell(5).textContent = interr.data_lezione || 'Non impostata';
        row.insertCell(6).textContent = interr.ordine;
        row.insertCell(7).textContent = formatDate(interr.created_at);
    });
}

// Mostra dettagli interrogazione
async function showDetails(id) {
    const modal = document.getElementById('detailsModal');
    const content = document.getElementById('detailsContent');
    
    try {
        const response = await fetch(`/api/interrogations/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        const interr = data.interrogation;
        content.innerHTML = `
            <table style="width: 100%;">
                <tr><td><strong>ID:</strong></td><td>${interr.id}</td></tr>
                <tr><td><strong>Materia:</strong></td><td>${interr.materia}</td></tr>
                <tr><td><strong>Studente:</strong></td><td>${interr.student.nome} ${interr.student.cognome}</td></tr>
                <tr><td><strong>Numero Registro:</strong></td><td>${interr.student.registro_num}</td></tr>
                <tr><td><strong>Lezione N¬∞:</strong></td><td>${interr.lezione_num}</td></tr>
                <tr><td><strong>Data Lezione:</strong></td><td>${interr.data_lezione || 'Non impostata'}</td></tr>
                <tr><td><strong>Ordine:</strong></td><td>${interr.ordine}</td></tr>
                <tr><td><strong>Creata il:</strong></td><td>${formatDate(interr.created_at)}</td></tr>
                <tr><td><strong>Aggiornata il:</strong></td><td>${formatDate(interr.updated_at)}</td></tr>
            </table>
        `;
        
        modal.style.display = 'block';
        
    } catch (error) {
        alert(`Errore: ${error.message}`);
    }
}

// Chiudi dettagli
function closeDetails() {
    document.getElementById('detailsModal').style.display = 'none';
}

// Reset filtri
function clearFilters() {
    document.getElementById('filterMateria').value = '';
    document.getElementById('filterStudent').value = '';
    document.getElementById('filterLimit').value = '';
    loadInterrogations();
}

// Formatta data
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('it-IT');
}

// Chiudi modal cliccando fuori
window.onclick = function(event) {
    const modal = document.getElementById('detailsModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Esporta in PDF
async function exportToPDF() {
    const materia = document.getElementById('filterMateria').value;
    
    if (!materia) {
        alert('Inserisci una materia per esportare in PDF');
        return;
    }
    
    try {
        const response = await fetch('/api/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                materia: materia,
                format: 'pdf'
            })
        });
        
        if (!response.ok) {
            throw new Error('Errore durante l\'esportazione');
        }
        
        // Scarica il file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `calendario_${materia}_${new Date().getTime()}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        alert('PDF esportato con successo!');
        
    } catch (error) {
        alert(`Errore: ${error.message}`);
    }
}

</script>
{% endblock %}
