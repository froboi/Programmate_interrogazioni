{% extends "base.html" %}

{% block title %}Gestione Interrogazioni{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 class="mb-0">
                            <i class="bi bi-list-check"></i>
                            Gestione Interrogazioni
                        </h3>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-download"></i>
                                Esporta
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="export-json">
                                    <i class="bi bi-file-earmark-code"></i> JSON
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="export-csv">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="export-pdf">
                                    <i class="bi bi-file-earmark-pdf"></i> PDF
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selezione Materia -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Seleziona Materia</label>
                        <select class="form-select form-select-lg" id="select-materia">
                            <option value="">-- Seleziona una materia --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-lg" id="btn-load-interrogations">
                            <i class="bi bi-arrow-repeat"></i>
                            Carica Interrogazioni
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche -->
        <div class="row mb-4" id="stats-container" style="display: none;">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h3 class="text-primary" id="stat-extractions">0</h3>
                        <p class="mb-0"><i class="bi bi-calendar3"></i> Estrazioni</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h3 class="text-success" id="stat-total">0</h3>
                        <p class="mb-0"><i class="bi bi-people"></i> Studenti</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h3 class="text-info" id="stat-avg">0</h3>
                        <p class="mb-0"><i class="bi bi-calculator"></i> Media/Estrazione</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h3 class="text-warning" id="stat-materia"></h3>
                        <p class="mb-0"><i class="bi bi-book"></i> Materia</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container Estrazioni -->
        <div id="extractions-container"></div>

    </div>
</div>

<!-- Modal: Modifica Studente -->
<div class="modal fade" id="modalEditStudent" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i>
                    Modifica Studente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Studente corrente: <strong id="modal-current-student-name"></strong></p>
                <div class="mb-3">
                    <label class="form-label">Nuovo Numero Registro</label>
                    <input type="number" class="form-control" id="modal-new-registro" min="1" placeholder="Inserisci nuovo numero registro">
                </div>
                <input type="hidden" id="modal-interrogation-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="btn-save-change">
                    <i class="bi bi-check-circle"></i>
                    Salva Modifica
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentMateria = '';
    let interrogationsData = null;
    
    // Carica materie disponibili
    loadMaterie();
    
    function loadMaterie() {
        $.get('/api/interrogations/all-materie', function(response) {
            if (response.success) {
                const select = $('#select-materia');
                response.materie.forEach(materia => {
                    select.append(`<option value="${materia}">${materia}</option>`);
                });
            }
        });
    }
    
    // Carica interrogazioni
    $('#btn-load-interrogations').on('click', function() {
        const materia = $('#select-materia').val();
        
        if (!materia) {
            showAlert('Seleziona una materia', 'warning');
            return;
        }
        
        currentMateria = materia;
        loadInterrogations(materia);
    });
    
    function loadInterrogations(materia) {
        $.get(`/api/interrogations/by-materia/${encodeURIComponent(materia)}`, function(response) {
            if (response.success) {
                interrogationsData = response;
                renderInterrogations(response);
                updateStats(response);
                $('#stats-container').show();
            } else {
                showAlert('Errore: ' + response.error, 'danger');
            }
        }).fail(function() {
            showAlert('Errore nel caricamento delle interrogazioni', 'danger');
        });
    }
    
    function renderInterrogations(data) {
        const container = $('#extractions-container');
        container.empty();
        
        if (data.groups.length === 0) {
            container.html('<div class="alert alert-info">Nessuna interrogazione trovata per questa materia.</div>');
            return;
        }
        
        data.groups.forEach((group, index) => {
            const groupHtml = createGroupCard(group, index + 1);
            container.append(groupHtml);
        });
    }
    
    function createGroupCard(group, groupIndex) {
        const dataDisplay = group.data_lezione ? formatDate(group.data_lezione) : '<span class="text-muted">Non assegnata</span>';
        
        let studentsHtml = '';
        group.studenti.forEach((student) => {
            const badgeColor = groupIndex % 2 === 0 ? 'primary' : 'success';
            studentsHtml += `
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card h-100 border-${badgeColor}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-${badgeColor}">Ordine ${student.ordine}</span>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="openEditModal(${student.id}, '${student.student.nome} ${student.student.cognome}', ${student.student.registro_num})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                            <h6 class="card-title mb-1">
                                <i class="bi bi-person-badge"></i>
                                ${student.student.registro_num}
                            </h6>
                            <p class="card-text mb-0">
                                <strong>${student.student.nome} ${student.student.cognome}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        return `
            <div class="card shadow mb-4">
                <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="bi bi-flag-fill"></i>
                                Estrazione ${group.lezione_num}
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-light text-dark fs-6">
                                <i class="bi bi-calendar-event"></i> ${dataDisplay}
                            </span>
                            <span class="badge bg-light text-dark fs-6 ms-2">
                                <i class="bi bi-people"></i> ${group.studenti.length} studenti
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${studentsHtml}
                    </div>
                </div>
            </div>
        `;
    }
    
    function formatDate(dateStr) {
        if (!dateStr || dateStr === 'None' || dateStr === 'null') {
            return '<span class="text-muted">Non assegnata</span>';
        }
        
        try {
            // Gestisce diversi formati di data
            let date;
            if (dateStr.includes('T')) {
                date = new Date(dateStr);
            } else {
                // Formato YYYY-MM-DD
                date = new Date(dateStr + 'T00:00:00');
            }
            
            // Verifica se la data Ã¨ valida
            if (isNaN(date.getTime())) {
                return '<span class="text-muted">Data non valida</span>';
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('it-IT', options);
        } catch (e) {
            return '<span class="text-muted">Errore formato data</span>';
        }
    }
    
    function updateStats(data) {
        $('#stat-extractions').text(data.total_lessons);
        $('#stat-total').text(data.total_students);
        const avg = data.total_lessons > 0 ? (data.total_students / data.total_lessons).toFixed(1) : 0;
        $('#stat-avg').text(avg);
        $('#stat-materia').text(data.materia);
    }
    
    // Apri modale modifica
    window.openEditModal = function(interrogationId, studentName, registroNum) {
        $('#modal-interrogation-id').val(interrogationId);
        $('#modal-current-student-name').text(studentName);
        $('#modal-new-registro').val('');
        $('#modalEditStudent').modal('show');
    };
    
    // Salva modifica studente
    $('#btn-save-change').on('click', function() {
        const interrogationId = $('#modal-interrogation-id').val();
        const newRegistro = $('#modal-new-registro').val();
        
        if (!newRegistro) {
            showAlert('Inserisci un numero di registro', 'warning');
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true);
        
        $.ajax({
            url: '/api/interrogations/update-student',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                interrogation_id: parseInt(interrogationId),
                new_registro_num: parseInt(newRegistro)
            }),
            success: function(response) {
                if (response.success) {
                    showAlert('Studente modificato con successo!', 'success');
                    $('#modalEditStudent').modal('hide');
                    loadInterrogations(currentMateria); // Ricarica
                } else {
                    showAlert('Errore: ' + response.error, 'danger');
                }
                btn.prop('disabled', false);
            },
            error: function() {
                showAlert('Errore nella comunicazione con il server', 'danger');
                btn.prop('disabled', false);
            }
        });
    });
    
    // Export JSON
    $('#export-json').on('click', function(e) {
        e.preventDefault();
        if (!currentMateria) {
            showAlert('Seleziona e carica prima una materia', 'warning');
            return;
        }
        window.location.href = `/api/interrogations/export/${encodeURIComponent(currentMateria)}/json`;
    });
    
    // Export CSV
    $('#export-csv').on('click', function(e) {
        e.preventDefault();
        if (!currentMateria) {
            showAlert('Seleziona e carica prima una materia', 'warning');
            return;
        }
        window.location.href = `/api/interrogations/export/${encodeURIComponent(currentMateria)}/csv`;
    });
    
    // Export PDF
    $('#export-pdf').on('click', function(e) {
        e.preventDefault();
        if (!currentMateria) {
            showAlert('Seleziona e carica prima una materia', 'warning');
            return;
        }
        window.location.href = `/api/interrogations/export/${encodeURIComponent(currentMateria)}/pdf`;
    });
    
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);
        
        setTimeout(() => {
            $('.alert').fadeOut('slow', function() {
                $(this).remove();
            });
        }, 3000);
    }
});
</script>
{% endblock %}
